version: 2.1

jobs:
  build-and-push:
    docker:
      - image: cimg/node:20.11  # Node.js + Docker preinstalado

    steps:
      - checkout

      # Instalar dependencias
      - run:
          name: Install dependencies
          command: npm install

      # Ejecutar pruebas unitarias
      - run:
          name: Run unit tests
          command: npm run test:unit

      # Ejecutar pruebas de integraci√≥n (si existen)
      - run:
          name: Run integration tests
          command: npm run test:integration || echo "No integration tests found"

      # Ejecutar Linter
      - run:
          name: Run linter
          command: npm run lint

      # Construir imagen Docker
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Build Docker image
          command: docker build -t $DOCKER_LOGIN/$IMAGE_NAME:$TAG .

      # Login en Docker Hub y push de imagen
      - run:
          name: Push Docker image to Docker Hub
          command: |
            echo $DOCKER_PWD | docker login -u $DOCKER_LOGIN --password-stdin
            docker push $DOCKER_LOGIN/$IMAGE_NAME:$TAG

      # Ejecutar la aplicaci√≥n directamente en CircleCI usando el script "start"
      - run:
          name: Run application
          command: |
            echo "Iniciando la aplicaci√≥n..."
            npm start  # Esto ejecuta app.js seg√∫n tu package.json

# üîπ Definimos el workflow para ejecutar el job
workflows:
  version: 2
  ci-cd:
    jobs:
      - build-and-push
