version: 2.1

jobs:
  build-and-push:
    docker:
      # Imagen oficial de CircleCI con Node.js y Docker preinstalado
      - image: cimg/node:20.11

    steps:
      - checkout

      # Instalar dependencias
      - run:
          name: Install dependencies
          command: |
            npm install

      # Ejecutar pruebas unitarias
      - run:
          name: Run unit tests
          command: |
            npm run test:unit

      # Ejecutar pruebas de integraci√≥n (si existen)
      - run:
          name: Run integration tests
          command: |
            npm run test:integration || echo "No integration tests found"

      # Ejecutar Linter
      - run:
          name: Run linter
          command: |
            npm run lint

      # Construir imagen Docker
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Build Docker image
          command: |
            docker build -t $DOCKER_LOGIN/$IMAGE_NAME:$TAG .

      # Login en Docker Hub y push de imagen
      - run:
          name: Push Docker image to Docker Hub
          command: |
            echo $DOCKER_PWD | docker login -u $DOCKER_LOGIN --password-stdin
            docker push $DOCKER_LOGIN/$IMAGE_NAME:$TAG

workflows:
  ci-cd:
    jobs:
      - build-and-push
